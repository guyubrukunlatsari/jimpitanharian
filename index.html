<script>
  const sheetId = "1g1fp70L86yFkZt6OcOQjdKK9kgtHmPb2TqLou7a-4Pw";
  const sheetName = "Laporan Jimpitan Harian";
  const query = encodeURIComponent("SELECT A,B,C,E,F,G,H,I");
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tq=${query}`;

  let allData = [];
  let filteredData = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  fetch(url)
    .then(res => res.text())
    .then(rep => {
      const json = JSON.parse(rep.substr(47).slice(0, -2));
      const rows = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));

      const formatTanggal = (t) => {
        if (typeof t === "string" && t.includes("Date(")) {
          const match = t.match(/Date\((\d+),(\d+),(\d+)\)/);
          if (match) {
            const y = parseInt(match[1]);
            const m = parseInt(match[2]);
            const d = parseInt(match[3]);
            return new Date(y, m, d).toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric"
            });
          }
        }
        return t;
      };

      allData = rows.map((r, i) => ({
        no: i + 1,
        tanggal: formatTanggal(r[1]),
        hari: r[2],
        hadir: r[3],
        izin: r[4],
        alpha: r[5],
        hasil: r[6],
        ket: r[7]
      }));

      allData = allData.reverse();
      filteredData = allData;
      renderTable();
    })
    .catch(err => {
      document.getElementById("table-body").innerHTML =
        `<tr><td colspan="8">❌ Gagal memuat data: ${err.message}</td></tr>`;
    });

  function renderTable() {
    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const dataToShow = filteredData.slice(start, end);

    if (dataToShow.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8">Tidak ada data</td></tr>`;
      document.getElementById("pagination").innerHTML = "";
      return;
    }

    dataToShow.forEach((row, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${start + index + 1}</td>
        <td>${row.tanggal}</td>
        <td>${row.hari}</td>
        <td>${row.hadir}</td>
        <td>${row.izin}</td>
        <td>${row.alpha}</td>
        <td class="hasil">${row.hasil}</td>
        <td style="text-align:left">${row.ket}</td>
      `;
      tbody.appendChild(tr);
    });

    renderPagination();
  }

  function renderPagination() {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "⬅️";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { currentPage--; renderTable(); };
    pagination.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.textContent = i;
      if (i === currentPage) pageBtn.classList.add("active");
      pageBtn.onclick = () => { currentPage = i; renderTable(); };
      pagination.appendChild(pageBtn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "➡️";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { currentPage++; renderTable(); };
    pagination.appendChild(nextBtn);
  }

  // ✅ Konversi tanggal lokal (contoh: "28 Oktober 2025") ke Date object
  function parseIndoDate(str) {
    const bulanMap = {
      Januari: 0, Februari: 1, Maret: 2, April: 3, Mei: 4, Juni: 5,
      Juli: 6, Agustus: 7, September: 8, Oktober: 9, November: 10, Desember: 11
    };
    const parts = str.split(" ");
    if (parts.length === 3) {
      const d = parseInt(parts[0]);
      const m = bulanMap[parts[1]];
      const y = parseInt(parts[2]);
      return new Date(y, m, d);
    }
    return null;
  }

  function applyFilter() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    if (!start || !end) {
      alert("Pilih tanggal awal dan akhir terlebih dahulu.");
      return;
    }

    const startDate = new Date(start);
    const endDate = new Date(end);

    filteredData = allData.filter(row => {
      const tgl = parseIndoDate(row.tanggal);
      return tgl && tgl >= startDate && tgl <= endDate;
    });

    currentPage = 1;
    renderTable();
  }

  function resetFilter() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    filteredData = allData;
    currentPage = 1;
    renderTable();
  }
</script>
